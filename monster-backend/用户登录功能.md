# 后端实现用户登录功能

## 设计数据库ERD

先设计一个简单的用户表，主要包含用户id、用户名、密码、创建时间、更新时间。

user
- id (INT) AUTO_INCREMENT, PRIMARY KEY
- username (VARCHAR 255) UNIQUE
- password (VARCHAR 255)
- created_at (DATETIME)
- updated_at (DATETIME)

创建表的sql语句如下：

```sql
CREATE TABLE `user` (
    `id` INT(11) NOT NULL AUTO_INCREMENT,
    `username` VARCHAR(255) NOT NULL UNIQUE,
    `password` VARCHAR(255) NOT NULL,
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`)
)

```

新建管理员admin 密码'password'使用HASH加密 
```sql
INSERT INTO `user` (`username`, `password`) VALUES ('admin', '$2b$10$I2bC9OCTn1.jFfBygy8UVuHwfj693vPSzDFHBtFegs2oCV1kIDmCe');
```

## 使用 Node.js 实现记住登录状态的功能，可以使用 Cookie 或者 JSON Web Token (JWT) 的方式。

1、使用Cookie实现：
当用户勾选“记住我”后，服务器通过设置一个 httpOnly 的 Cookie，将用户信息加密后存储在 Cookie 中，并设置 Cookie 的过期时间。下次用户访问相同的网站时，浏览器会自动发送该 Cookie 到服务器，服务器就能够识别该用户身份，并自动登录。

以下是一个示例代码：
```js
const express = require('express')
const cookieParser = require('cookie-parser')

const app = express()
app.use(cookieParser())

app.get('/login', (req, res) => {
  const { username, password, remember } = req.body
  
  // 验证用户名和密码，获取用户信息
  // ...

  if (remember) {
    // 如果用户选择了"记住我"，则设置Cookie，有效期为1天
    res.cookie('user', userInfo, { maxAge: 1000 * 60 * 60 * 24 })
  } else {
    // 如果用户没有选择"记住我"，则设置Session，有效期为30分钟
    req.session.user = userInfo
    req.session.cookie.expires = new Date(Date.now() + 30 * 60 * 1000)
  }

  // 返回登录成功信息
  res.send('Login success')
})

app.get('/profile', (req, res) => {
  const user = req.cookies.user || req.session.user

  // 判断用户是否已登录
  if (!user) {
    return res.redirect('/login')
  }

  // 返回用户信息
  res.send(`Welcome, ${user.username}!`)
})

```

2.使用JSON Web Token (JWT)实现：
当用户勾选“记住我”后，服务器通过生成一个 JWT，将用户信息加密后存储在 JWT 中，并设置 JWT 的过期时间。下次用户访问相同的网站时，客户端需要携带该 JWT，服务器就能够识别该用户身份，并自动登录。

以下是一个示例代码：
```js
const express = require('express')
const jwt = require('jsonwebtoken')

const app = express()

app.get('/login', (req, res) => {
  const { username, password, remember } = req.body

  // 验证用户名和密码，获取用户信息
  // ...

  const token = jwt.sign(userInfo, 'secretKey', { expiresIn: remember ? '1d' : '30m' })

  // 返回登录成功信息和Token
  res.json({ message: 'Login success', token })
})

app.get('/profile', (req, res) => {
  const token = req.headers.authorization.split(' ')[1]
  
  try {
    const user = jwt.verify(token, 'secretKey')
    
    // 返回用户信息
    res.send(`Welcome, ${user.username}!`)
  } catch (err) {
    // 验证失败，返回错误信息
    res.status(401).json({ message: 'Invalid token' })
  }
})
```


## 设计一个 RESTful 风格的用户登录接口，可以考虑以下设计：

URL: /api/login
HTTP 方法：POST
请求体（body）：包含用户名和密码字段
响应状态码：
200 OK: 登录成功，返回登陆成功信息以及用户信息。
401 Unauthorized: 用户名或密码错误。
500 Internal Server Error: 服务器发生错误。
下面是一个示例实现，使用 Express 框架和 JSON 格式作为请求体和响应：

```js
const express = require('express');
const app = express();

// 处理 POST /api/login 请求
app.post('/api/login', (req, res) => {
  const { username, password } = req.body;

  // 在这里验证用户名和密码是否正确
  if (username === 'admin' && password === 'password') {
    // 如果验证通过，返回成功响应
    res.status(200).json({
      message: 'Login successful',
      user: {
        id: 123,
        name: 'Admin'
      }
    });
  } else {
    // 如果验证失败，返回未授权响应
    res.status(401).json({
      message: 'Invalid username or password'
    });
  }
});

// 启动服务器
app.listen(3000, () => {
  console.log('Server started on port 3000');
});

```

在实际应用中，你需要编写更详细的代码来处理验证、加密、数据库查询等一系列操作。但是这个示例可以给你一个基本的想法，如何设计并实现一个简单的 RESTful 风格的用户登录接口。